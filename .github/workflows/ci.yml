name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build & Test (PG ${{ matrix.pg_version }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        pg_version: [REL_14_STABLE, REL_15_STABLE, REL_16_STABLE]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libtool \
          autoconf \
          automake \
          pkg-config \
          libreadline-dev \
          zlib1g-dev \
          flex \
          bison \
          cmake \
          libxml2-dev \
          libxslt-dev \
          libssl-dev \
          libxml2-utils \
          xsltproc \
          ccache

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ubuntu-24.04-${{ matrix.pg_version }}

    - name: Checkout PostgreSQL code
      run: |
        rm -rf postgres
        git clone --branch ${{ matrix.pg_version }} --single-branch --depth 1 https://github.com/postgres/postgres.git

    - name: Cache PostgreSQL build
      id: cache-pg-build
      uses: actions/cache@v4
      with:
        path: postgres/inst
        key: pg-build-ubuntu-24.04-${{ matrix.pg_version }}

    - name: Build PostgreSQL
      if: steps.cache-pg-build.outputs.cache-hit != 'true'
      working-directory: postgres
      run: |
        ./configure --prefix=$PWD/inst --enable-cassert --enable-debug
        make -j$(nproc) install

    - name: Cache MonetDB installation
      id: cache-monetdb
      uses: actions/cache@v4
      with:
        path: monetdb-cache
        key: monetdb-11.56-${{ runner.os }}

    - name: Build MonetDB from source
      if: steps.cache-monetdb.outputs.cache-hit != 'true'
      run: |
        git clone --depth 1 https://github.com/MonetDB/MonetDB.git
        cd MonetDB
        mkdir build && cd build
        cmake .. -DCMAKE_INSTALL_PREFIX=$PWD/../monetdb-install \
                 -DWITH_MAPI=ON \
                 -DWITH_MONITORING=OFF \
                 -DWITH_TESTING=OFF
        make -j$(nproc)
        make install
        cd ../..
        mv MonetDB/monetdb-install monetdb-cache

    - name: Setup environment
      run: |
        echo "PATH=$PWD/postgres/inst/bin:$PATH" >> $GITHUB_ENV
        echo "MONETDB_HOME=$PWD/monetdb-cache" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=$PWD/monetdb-cache/lib:$PWD/postgres/inst/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV

    - name: Build MonetDB_fdw
      run: |
        make clean || true
        make -j$(nproc)

    - name: Install MonetDB_fdw
      run: |
        make install

    - name: Start MonetDB server
      run: |
        mkdir -p /tmp/monetdb_test
        $MONETDB_HOME/bin/mserver5 --dbpath=/tmp/monetdb_test --set mapi_port=50000 >/dev/null 2>&1 &
        sleep 5

    - name: Run regression tests
      run: |
        make installcheck || {
          echo "Regression tests failed. Showing diff:"
          cat regression.diffs || true
          exit 1
        }
      continue-on-error: true

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.pg_version }}
        path: |
          regression.diffs
          regression.out
        retention-days: 7
