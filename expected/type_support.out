-- Set timezone to UTC for consistent test results
SET timezone = 'UTC';
select monetdb_execute('foreign_server', $$CREATE TABLE Numeric_Types(
	a TINYINT,
	b SMALLINT,
	c INTEGER,
	d BIGINT,
	-- e HUGEINT,
	f DECIMAL,
	g NUMERIC(38, 3),
	h REAL,
	i DOUBLE PRECISION,
	j FLOAT
)$$);
 monetdb_execute 
-----------------
 
(1 row)

IMPORT FOREIGN SCHEMA "test_u" limit to (Numeric_Types) from server foreign_server into public;
-- Verify foreign table is correctly created
SELECT c.relname as "Table",
       s.srvname as "Server",
       array_to_string(ft.ftoptions, ', ') as "FDW options"
FROM pg_foreign_table ft
     JOIN pg_class c ON c.oid = ft.ftrelid
     JOIN pg_foreign_server s ON s.oid = ft.ftserver
WHERE c.relname = 'numeric_types';
     Table     |     Server     |                 FDW options                  
---------------+----------------+----------------------------------------------
 numeric_types | foreign_server | schema_name=test_u, table_name=numeric_types
(1 row)

-- test TINYINT
INSERT INTO Numeric_Types(a) VALUES(-127 - 1);
ERROR:  value for domain tinyint violates check constraint "tinyint_check"
INSERT INTO Numeric_Types(a) VALUES(127);
INSERT INTO Numeric_Types(a) VALUES(127 + 1);
ERROR:  value for domain tinyint violates check constraint "tinyint_check"
SELECT * FROM Numeric_Types;
  a  | b | c | d | f | g | h | i | j 
-----+---+---+---+---+---+---+---+---
 127 |   |   |   |   |   |   |   |  
(1 row)

TRUNCATE Numeric_Types;
-- test SMALLINT
INSERT INTO Numeric_Types(b) VALUES(-32767 - 1);
ERROR:  [MonetDB RESULT ERROR] conversion of string '-32768' to type sht failed.

INSERT INTO Numeric_Types(b) VALUES(32767);
INSERT INTO Numeric_Types(b) VALUES(32767 + 1);
ERROR:  smallint out of range
SELECT * FROM Numeric_Types;
 a |   b   | c | d | f | g | h | i | j 
---+-------+---+---+---+---+---+---+---
   | 32767 |   |   |   |   |   |   |  
(1 row)

TRUNCATE Numeric_Types;
-- test INTEGER
INSERT INTO Numeric_Types(c) VALUES(-2147483647 - 1);
ERROR:  [MonetDB RESULT ERROR] conversion of string '-2147483648' to type int failed.

INSERT INTO Numeric_Types(c) VALUES(2147483647);
INSERT INTO Numeric_Types(c) VALUES(2147483647 + 1);
ERROR:  integer out of range
SELECT * FROM Numeric_Types;
 a | b |     c      | d | f | g | h | i | j 
---+---+------------+---+---+---+---+---+---
   |   | 2147483647 |   |   |   |   |   |  
(1 row)

TRUNCATE Numeric_Types;
-- test BIGINT
INSERT INTO Numeric_Types(d) VALUES(-9223372036854775807 - 1);
ERROR:  [MonetDB RESULT ERROR] conversion of string '-9223372036854775808' to type lng failed.

INSERT INTO Numeric_Types(d) VALUES(9223372036854775807);
INSERT INTO Numeric_Types(d) VALUES(9223372036854775807 + 1);
ERROR:  bigint out of range
SELECT * FROM Numeric_Types;
 a | b | c |          d          | f | g | h | i | j 
---+---+---+---------------------+---+---+---+---+---
   |   |   | 9223372036854775807 |   |   |   |   |  
(1 row)

select monetdb_execute('foreign_server', $$CREATE TABLE bool_Types(
	a BOOLEAN
)$$);
 monetdb_execute 
-----------------
 
(1 row)

IMPORT FOREIGN SCHEMA "test_u" limit to (bool_Types) from server foreign_server into public;
-- Verify foreign table is correctly created
SELECT c.relname as "Table",
       s.srvname as "Server",
       array_to_string(ft.ftoptions, ', ') as "FDW options"
FROM pg_foreign_table ft
     JOIN pg_class c ON c.oid = ft.ftrelid
     JOIN pg_foreign_server s ON s.oid = ft.ftserver
WHERE c.relname = 'bool_types';
   Table    |     Server     |                FDW options                
------------+----------------+-------------------------------------------
 bool_types | foreign_server | schema_name=test_u, table_name=bool_types
(1 row)

-- test BOOLEAN
INSERT INTO bool_Types VALUES(true);
INSERT INTO bool_Types VALUES('true');
INSERT INTO bool_Types VALUES('1');
INSERT INTO bool_Types VALUES('t');
INSERT INTO bool_Types VALUES(false);
INSERT INTO bool_Types VALUES('false');
INSERT INTO bool_Types VALUES('0');
INSERT INTO bool_Types VALUES('f');
SELECT * FROM bool_Types;
 a 
---
 t
 t
 t
 t
 f
 f
 f
 f
(8 rows)

DROP FOREIGN TABLE bool_Types;
DROP FOREIGN TABLE Numeric_Types;
SELECT monetdb_execute('foreign_server', $$DROP TABLE bool_Types$$);
 monetdb_execute 
-----------------
 
(1 row)

SELECT monetdb_execute('foreign_server', $$DROP TABLE Numeric_Types$$);
 monetdb_execute 
-----------------
 
(1 row)

-- test CHAR、VARCHAR、CLOB、TEXT、STRING
select monetdb_execute('foreign_server', $$CREATE TABLE Character_Types(
	a CHAR,
	b CHARACTER(10),
	c VARCHAR(20),
	d VARCHAR,
	e CLOB,
	f TEXT,  -- The TEXT type of the external table imported using IMPORT is not the TEXT type of PostgrSQL
	g STRING,
	h CLOB(10),
	i TEXT(20),
	j STRING(30) 
)$$);
 monetdb_execute 
-----------------
 
(1 row)

IMPORT FOREIGN SCHEMA "test_u" limit to (Character_Types) from server foreign_server into public;
-- Verify foreign table is correctly created
SELECT c.relname as "Table",
       s.srvname as "Server",
       array_to_string(ft.ftoptions, ', ') as "FDW options"
FROM pg_foreign_table ft
     JOIN pg_class c ON c.oid = ft.ftrelid
     JOIN pg_foreign_server s ON s.oid = ft.ftserver
WHERE c.relname = 'character_types';
      Table      |     Server     |                  FDW options                   
-----------------+----------------+------------------------------------------------
 character_types | foreign_server | schema_name=test_u, table_name=character_types
(1 row)

-- In fact, CLOB, TEXT, and STRING with precision information are not supported
CREATE TABLE Character_Types2(
	e CLOB,
	f TEXT,
	g STRING
);
DROP TABLE Character_Types2;
-- 
CREATE TABLE Character_Types2(h CLOB(10));      -- error
ERROR:  type modifier is not allowed for type "clob"
LINE 1: CREATE TABLE Character_Types2(h CLOB(10));
                                        ^
CREATE TABLE Character_Types2(i TEXT(20));      -- error
ERROR:  type modifier is not allowed for type "text"
LINE 1: CREATE TABLE Character_Types2(i TEXT(20));
                                        ^
CREATE TABLE Character_Types2(j STRING(30));    -- error
ERROR:  type modifier is not allowed for type "string"
LINE 1: CREATE TABLE Character_Types2(j STRING(30));
                                        ^
DROP FOREIGN TABLE Character_Types;
-- Create an external table with the following PG types
CREATE FOREIGN TABLE Character_Types(
	a CHAR,
	b CHARACTER(10),
	c VARCHAR(20),
	d VARCHAR,
	e CLOB,
	f TEXT,
	g STRING,
	h VARCHAR(10),
	i VARCHAR(20),
	j VARCHAR(30) 
)
SERVER foreign_server
OPTIONS (schema_name 'test_u', table_name 'Character_Types');
-- Verify foreign table is correctly created
SELECT c.relname as "Table",
       s.srvname as "Server",
       array_to_string(ft.ftoptions, ', ') as "FDW options"
FROM pg_foreign_table ft
     JOIN pg_class c ON c.oid = ft.ftrelid
     JOIN pg_foreign_server s ON s.oid = ft.ftserver
WHERE c.relname = 'character_types';
      Table      |     Server     |                  FDW options                   
-----------------+----------------+------------------------------------------------
 character_types | foreign_server | schema_name=test_u, table_name=Character_Types
(1 row)

DROP FOREIGN TABLE Character_Types;
SELECT monetdb_execute('foreign_server', $$DROP TABLE Character_Types$$);
 monetdb_execute 
-----------------
 
(1 row)

-- test TIMESTAMP、TIMESTAMP WITH TIME ZONE、DATE、TIME、TIME WITH TIME ZONE
select monetdb_execute('foreign_server', $$CREATE TABLE Time_Types(
	a TIMESTAMP,
	b TIMESTAMP WITH TIME ZONE,
	c DATE,
	d TIME,
	e TIME WITH TIME ZONE
)$$);
 monetdb_execute 
-----------------
 
(1 row)

IMPORT FOREIGN SCHEMA "test_u" limit to (Time_Types) from server foreign_server into public;
-- Verify foreign table is correctly created
SELECT c.relname as "Table",
       s.srvname as "Server",
       array_to_string(ft.ftoptions, ', ') as "FDW options"
FROM pg_foreign_table ft
     JOIN pg_class c ON c.oid = ft.ftrelid
     JOIN pg_foreign_server s ON s.oid = ft.ftserver
WHERE c.relname = 'time_types';
   Table    |     Server     |                FDW options                
------------+----------------+-------------------------------------------
 time_types | foreign_server | schema_name=test_u, table_name=time_types
(1 row)

-- Test data insertion
INSERT INTO time_types VALUES('2014-04-24 17:12:12.415', '2014-04-24 17:12:12.415 -02:00', '2014-04-24', '17:12:12.415', '17:12:12.415 -02:00');
-- Verify timestamp types (convert to text for consistent display)
SELECT a::text AS timestamp_without_tz,
       b AT TIME ZONE 'UTC' AS timestamp_with_tz_utc,
       c::text AS date
FROM time_types;
     timestamp_without_tz     |    timestamp_with_tz_utc     |    date    
------------------------------+------------------------------+------------
 Thu Apr 24 17:12:12.415 2014 | Thu Apr 24 19:12:12.415 2014 | 04-24-2014
(1 row)

-- Verify time types separately
SELECT d::text AS time_without_tz FROM time_types;
 time_without_tz 
-----------------
 17:12:12
(1 row)

SELECT e AT TIME ZONE 'UTC' AS time_with_tz_utc FROM time_types;
 time_with_tz_utc 
------------------
 19:12:12+00
(1 row)

DROP FOREIGN TABLE Time_Types;
SELECT monetdb_execute('foreign_server', $$DROP TABLE Time_Types$$);
 monetdb_execute 
-----------------
 
(1 row)

-- test JSON
select monetdb_execute('foreign_server', $$CREATE TABLE json_example (c1 JSON, c2 JSON(512) NOT NULL)$$);
 monetdb_execute 
-----------------
 
(1 row)

IMPORT FOREIGN SCHEMA "test_u" limit to (json_example) from server foreign_server into public;
-- Verify foreign table is correctly created
SELECT c.relname as "Table",
       s.srvname as "Server",
       array_to_string(ft.ftoptions, ', ') as "FDW options"
FROM pg_foreign_table ft
     JOIN pg_class c ON c.oid = ft.ftrelid
     JOIN pg_foreign_server s ON s.oid = ft.ftserver
WHERE c.relname = 'json_example';
    Table     |     Server     |                 FDW options                 
--------------+----------------+---------------------------------------------
 json_example | foreign_server | schema_name=test_u, table_name=json_example
(1 row)

INSERT INTO json_example values(
'{ "store": {
    "book": [
      { "category": "reference",
        "author": "Nigel Rees",
        "title": "Sayings of the Century",
        "price": 8.95
      },
      { "category": "fiction",
        "author": "Evelyn Waugh",
        "title": "Sword of Honour",
        "price": 12.99
      }
    ],
    "bicycle": {
      "color": "red",
      "price": 19.95
    }
  }
}',
'{ "store": {
    "book": [
      { "category": "reference",
        "author": "Nigel Rees",
        "title": "Sayings of the Century",
        "price": 8.95
      },
      { "category": "fiction",
        "author": "Evelyn Waugh",
        "title": "Sword of Honour",
        "price": 12.99
      }
    ],
    "bicycle": {
      "color": "red",
      "price": 19.95
    }
  }
}');
SELECT * FROM json_example;
                                                                                                                        c1                                                                                                                        |                                                                                                                        c2                                                                                                                        
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"store":{"book":[{"category":"reference","author":"Nigel Rees","title":"Sayings of the Century","price":8.95},{"category":"fiction","author":"Evelyn Waugh","title":"Sword of Honour","price":12.99}],"bicycle":{"color":"red","price":19.95}}} | {"store":{"book":[{"category":"reference","author":"Nigel Rees","title":"Sayings of the Century","price":8.95},{"category":"fiction","author":"Evelyn Waugh","title":"Sword of Honour","price":12.99}],"bicycle":{"color":"red","price":19.95}}}
(1 row)

SELECT jsonb_path_query(c1::jsonb, '$.store') FROM json_example;  -- use postgresql function
                                                                                                                      jsonb_path_query                                                                                                                       
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"book": [{"price": 8.95, "title": "Sayings of the Century", "author": "Nigel Rees", "category": "reference"}, {"price": 12.99, "title": "Sword of Honour", "author": "Evelyn Waugh", "category": "fiction"}], "bicycle": {"color": "red", "price": 19.95}}
(1 row)

-- CREATE TABLE json_example2(h JSON(512));      -- error
DROP FOREIGN TABLE json_example;
SELECT monetdb_execute('foreign_server', $$DROP TABLE json_example$$);
 monetdb_execute 
-----------------
 
(1 row)

-- test UUID
select monetdb_execute('foreign_server', $$CREATE TABLE uuid_example(a UUID)$$);
 monetdb_execute 
-----------------
 
(1 row)

IMPORT FOREIGN SCHEMA "test_u" limit to (uuid_example) from server foreign_server into public;
-- Verify foreign table is correctly created
SELECT c.relname as "Table",
       s.srvname as "Server",
       array_to_string(ft.ftoptions, ', ') as "FDW options"
FROM pg_foreign_table ft
     JOIN pg_class c ON c.oid = ft.ftrelid
     JOIN pg_foreign_server s ON s.oid = ft.ftserver
WHERE c.relname = 'uuid_example';
    Table     |     Server     |                 FDW options                 
--------------+----------------+---------------------------------------------
 uuid_example | foreign_server | schema_name=test_u, table_name=uuid_example
(1 row)

INSERT INTO uuid_example VALUES('26d7a80b-7538-4682-a49a-9d0f9676b765');
SELECT * FROM uuid_example;
                  a                   
--------------------------------------
 26d7a80b-7538-4682-a49a-9d0f9676b765
(1 row)

TRUNCATE uuid_example;
INSERT INTO uuid_example VALUES(gen_random_uuid());
SELECT count(*) FROM uuid_example;
 count 
-------
     1
(1 row)

DROP FOREIGN TABLE uuid_example;
SELECT monetdb_execute('foreign_server', $$DROP TABLE uuid_example$$);
 monetdb_execute 
-----------------
 
(1 row)

-- tes INET
select monetdb_execute('foreign_server', $$CREATE TABLE inet_example(a inet)$$);
 monetdb_execute 
-----------------
 
(1 row)

IMPORT FOREIGN SCHEMA "test_u" limit to (inet_example) from server foreign_server into public;
-- Verify foreign table is correctly created
SELECT c.relname as "Table",
       s.srvname as "Server",
       array_to_string(ft.ftoptions, ', ') as "FDW options"
FROM pg_foreign_table ft
     JOIN pg_class c ON c.oid = ft.ftrelid
     JOIN pg_foreign_server s ON s.oid = ft.ftserver
WHERE c.relname = 'inet_example';
    Table     |     Server     |                 FDW options                 
--------------+----------------+---------------------------------------------
 inet_example | foreign_server | schema_name=test_u, table_name=inet_example
(1 row)

INSERT INTO inet_example VALUES('192.168.1.5/24');
SELECT * FROM inet_example;
       a        
----------------
 192.168.1.5/24
(1 row)

DROP FOREIGN TABLE inet_example;
SELECT monetdb_execute('foreign_server', $$DROP TABLE inet_example$$);
 monetdb_execute 
-----------------
 
(1 row)

-- test URL
SELECT monetdb_execute('foreign_server', $$CREATE TABLE URL_example (c1 URL, c2 URL(512) NOT NULL)$$);
 monetdb_execute 
-----------------
 
(1 row)

IMPORT FOREIGN SCHEMA "test_u" limit to (URL_example) from server foreign_server into public;
-- Verify foreign table is correctly created
SELECT c.relname as "Table",
       s.srvname as "Server",
       array_to_string(ft.ftoptions, ', ') as "FDW options"
FROM pg_foreign_table ft
     JOIN pg_class c ON c.oid = ft.ftrelid
     JOIN pg_foreign_server s ON s.oid = ft.ftserver
WHERE c.relname = 'url_example';
    Table    |     Server     |                FDW options                 
-------------+----------------+--------------------------------------------
 url_example | foreign_server | schema_name=test_u, table_name=url_example
(1 row)

INSERT INTO url_example VALUES('https://github.com/Z-Xiao-M/MonetDB_fdw', 'https://github.com/Z-Xiao-M/MonetDB_fdw');
SELECT * FROM URL_example;
                   c1                    |                   c2                    
-----------------------------------------+-----------------------------------------
 https://github.com/Z-Xiao-M/MonetDB_fdw | https://github.com/Z-Xiao-M/MonetDB_fdw
(1 row)

DROP FOREIGN TABLE URL_example;
SELECT monetdb_execute('foreign_server', $$DROP TABLE URL_example$$);
 monetdb_execute 
-----------------
 
(1 row)

-- CREATE TABLE URL_example(h URL(512));      -- error
-- Switch back to monetdb user to delete test_u user
DROP USER MAPPING FOR CURRENT_USER SERVER foreign_server;
CREATE USER MAPPING FOR CURRENT_USER SERVER foreign_server OPTIONS (user 'monetdb', password 'monetdb');
SELECT monetdb_execute('foreign_server', $$ALTER USER test_u SET SCHEMA sys$$);
 monetdb_execute 
-----------------
 
(1 row)

SELECT monetdb_execute('foreign_server', $$DROP SCHEMA test_u$$);
 monetdb_execute 
-----------------
 
(1 row)

SELECT monetdb_execute('foreign_server', $$DROP USER test_u$$);
 monetdb_execute 
-----------------
 
(1 row)

